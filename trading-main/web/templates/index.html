{% extends "base.html" %}

{% block title %}ä¸»é¡µ - äº¤æ˜“ç³»ç»Ÿ{% endblock %}
{% block page_title %}ç³»ç»Ÿæ¦‚è§ˆ{% endblock %}

{% block content %}
<!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
<div class="row">
    <!-- ç³»ç»ŸçŠ¶æ€ -->
    <div class="col-md-3 mb-4">
        <div class="card border-primary">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">ç³»ç»ŸçŠ¶æ€</h6>
                        <h4 class="mb-0" id="systemStatus">
                            <span class="badge bg-secondary">æœªçŸ¥</span>
                        </h4>
                        <small class="text-muted">è¿è¡Œæ—¶é—´: <span id="runtimeHours">0.0å°æ—¶</span></small>
                    </div>
                    <div class="text-end">
                        <i class="fas fa-cogs fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    
    <!-- ä»Šæ—¥æ”¶ç›Š -->
    <div class="col-md-3 mb-4">
        <div class="card border-warning">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">ä»Šæ—¥æ”¶ç›Š</h6>
                        <h4 class="mb-0 text-warning" id="dailyPnL">$0.00</h4>
                        <small class="text-muted">æ”¶ç›Šç‡: <span id="dailyReturn">0.00%</span></small>
                    </div>
                    <div class="text-end">
                        <i class="fas fa-chart-line fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ€»æ”¶ç›Š -->
    <div class="col-md-3 mb-4">
        <div class="card border-success">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">æ€»æ”¶ç›Š</h6>
                        <h4 class="mb-0 text-success" id="totalPnL">$0.00</h4>
                        <small class="text-muted">æ”¶ç›Šç‡: <span id="totalReturn">0.00%</span></small>
                    </div>
                    <div class="text-end">
                        <i class="fas fa-coins fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è´¦æˆ·æ¦‚è§ˆ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-wallet me-2"></i>è´¦æˆ·æ¦‚è§ˆ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- èµ„é‡‘ä¿¡æ¯ -->
                    <div class="col-md-3 mb-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <div class="text-muted mb-1">å½“å‰èµ„é‡‘</div>
                            <div id="currentCapital" class="h4 mb-0 text-primary fw-bold">${{ "%.2f"|format(dashboard.current_capital) }}</div>
                            <small class="text-muted">æ€»èµ„äº§</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <div class="text-muted mb-1">å¯ç”¨èµ„é‡‘</div>
                            <div id="availableCapital" class="h4 mb-0 text-success fw-bold">${{ "%.2f"|format(dashboard.current_capital) }}</div>
                            <small class="text-muted">å¯äº¤æ˜“</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <div class="text-muted mb-1">èµ„é‡‘åˆ©ç”¨ç‡</div>
                            <div id="capitalUtilization" class="h4 mb-0 text-warning fw-bold">0.00%</div>
                            <small class="text-muted">ä½¿ç”¨æ¯”ä¾‹</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <div class="text-muted mb-1">äº¤æ˜“æ¨¡å¼</div>
                            <div id="tradingModeStatus" class="h4 mb-0 text-info fw-bold">æ¨¡æ‹Ÿäº¤æ˜“</div>
                            <small class="text-muted">è¿è¡ŒçŠ¶æ€</small>
                        </div>
                    </div>
                </div>
                
                <!-- æŒä»“ä¿¡æ¯ -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card border-0 bg-gradient-light">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2 text-center">
                                        <div class="position-icon mb-2">
                                            <i id="positionIcon" class="fas fa-chart-line fa-2x text-muted"></i>
                                        </div>
                                        <div id="positionStatus" class="fw-bold">æ— ä»“ä½</div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="text-muted mb-1">æŒä»“æ•°é‡</div>
                                        <div id="positionQuantity" class="h5 mb-0">0.0000 ETH</div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="text-muted mb-1">æŒä»“ä»·å€¼</div>
                                        <div id="positionValue" class="h5 mb-0">$0.00</div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="text-muted mb-1">æœªå®ç°ç›ˆäº</div>
                                        <div id="positionUnrealizedPnL" class="h5 mb-0">$0.00</div>
                                        <small id="positionUnrealizedPercent" class="text-muted">(0.00%)</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="text-muted mb-1">æ€»äº¤æ˜“æ¬¡æ•°</div>
                                        <div id="totalTrades" class="h5 mb-0">{{ dashboard.total_trades }}</div>
                                        <small class="text-muted">ä»Šæ—¥: <span id="dailyTrades">{{ dashboard.daily_trades }}</span></small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="text-muted mb-1">èƒœç‡</div>
                                        <div id="winRate" class="h5 mb-0">0.0%</div>
                                        <small class="text-muted">ç›ˆåˆ©/äºæŸ: <span id="winningTrades">0</span>/<span id="losingTrades">0</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¿è¡Œæ¨¡å¼å’Œç³»ç»Ÿæ§åˆ¶ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>è¿è¡Œæ§åˆ¶
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- äº¤æ˜“æ¨¡å¼ -->
                    <div class="col-md-6">
                        <div class="border-end pe-md-4">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-toggle-on me-2"></i>äº¤æ˜“æ¨¡å¼
                            </h6>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="h5 mb-1">
                                        <span id="trading_mode_icon_main">{{ trading_mode.mode_icon if trading_mode else 'ğŸŸ¡' }}</span>
                                        <span id="trading_mode_text_main">{{ trading_mode.trading_mode if trading_mode else 'æ¨¡æ‹Ÿäº¤æ˜“' }}</span>
                                    </div>
                                    <small class="text-muted" id="trading_mode_warning_main">
                                        {{ trading_mode.warning_message if trading_mode else 'ğŸŸ¡ æ¨¡æ‹Ÿäº¤æ˜“æ¨¡å¼ï¼Œä¸ä¼šä½¿ç”¨çœŸå®èµ„é‡‘' }}
                                    </small>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button" class="btn btn-outline-danger {{ 'active' if trading_mode and trading_mode.real_trading else '' }}" 
                                        id="real_mode_btn_main" onclick="switchTradingMode('real')"
                                        {{ 'disabled' if trading_mode and not trading_mode.can_switch_to_real else '' }}>
                                    <i class="fas fa-exclamation-triangle me-1"></i>çœŸå®äº¤æ˜“
                                </button>
                                <button type="button" class="btn btn-outline-warning {{ 'active' if trading_mode and not trading_mode.real_trading else '' }}" 
                                        id="simulation_mode_btn_main" onclick="switchTradingMode('simulation')">
                                    <i class="fas fa-shield-alt me-1"></i>æ¨¡æ‹Ÿäº¤æ˜“
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç³»ç»Ÿæ§åˆ¶ -->
                    <div class="col-md-6">
                        <div class="ps-md-4">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-power-off me-2"></i>ç³»ç»Ÿæ§åˆ¶
                            </h6>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="h5 mb-1">
                                        <span id="system_status_text">ç³»ç»ŸçŠ¶æ€</span>
                                    </div>
                                    <small class="text-muted" id="system_status_desc">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ§åˆ¶ç³»ç»Ÿè¿è¡Œ</small>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button" class="btn btn-success" onclick="startSystem()">
                                    <i class="fas fa-play me-1"></i>å¯åŠ¨ç³»ç»Ÿ
                                </button>
                                <button type="button" class="btn btn-danger" onclick="stopSystem()">
                                    <i class="fas fa-stop me-1"></i>åœæ­¢ç³»ç»Ÿ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- ä¿¡å·è¯¦æƒ… -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>ä¿¡å·è¯¦æƒ…
                </h5>
                <div class="d-flex align-items-center">
                    <small class="text-muted me-3">æœ€åæ›´æ–°: <span id="signalUpdateTime">-</span></small>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshSignalDetails()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- ä¿¡å·æ¦‚è§ˆ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-gradient-primary text-white">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2 text-center">
                                        <div class="signal-icon mb-2">
                                            <i id="signalIcon" class="fas fa-question-circle fa-3x"></i>
                                        </div>
                                        <h4 id="signalType" class="mb-0">æ— ä¿¡å·</h4>
                                        <small id="signalTime">-</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="price-info">
                                            <small class="opacity-75">å½“å‰ä»·æ ¼</small>
                                            <h3 id="signalPrice" class="mb-0">$0.00</h3>
                                            <small id="signalSymbol" class="opacity-75">ETHUSDT</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="score-info">
                                            <small class="opacity-75">ç»¼åˆè¯„åˆ†</small>
                                            <h3 id="signalScoreMain" class="mb-0 score-number">0.000</h3>
                                            <small id="signalStrength" class="opacity-75">å¼ºåº¦: å¼±</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="position-info">
                                            <small class="opacity-75">å»ºè®®ä»“ä½</small>
                                            <h3 id="signalPosition" class="mb-0">0.0%</h3>
                                            <small id="signalDirection" class="opacity-75">æ–¹å‘: è§‚æœ›</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="trend-info">
                                            <small class="opacity-75">è¶‹åŠ¿è¯„åˆ†</small>
                                            <h3 id="trendScoreMain" class="mb-0 score-number">0.000</h3>
                                            <small id="trendStatus" class="opacity-75">ä¸­æ€§</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="risk-info">
                                            <small class="opacity-75">é£é™©è¯„åˆ†</small>
                                            <h3 id="riskScoreMain" class="mb-0 score-number">0.000</h3>
                                            <small id="riskStatus" class="opacity-75">ä½é£é™©</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æŠ€æœ¯æŒ‡æ ‡å’Œè¿‡æ»¤çŠ¶æ€ -->
                <div class="row">
                    <!-- æŠ€æœ¯æŒ‡æ ‡ -->
                    <div class="col-md-8 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-area me-2"></i>æŠ€æœ¯æŒ‡æ ‡
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">RSI</div>
                                            <div id="rsiValue" class="indicator-value fw-bold fs-5">0.0</div>
                                            <div id="rsiStatus" class="indicator-status small mt-1">æ­£å¸¸</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">MACD</div>
                                            <div id="macdValue" class="indicator-value fw-bold fs-5">0.00</div>
                                            <div id="macdStatus" class="indicator-status small mt-1">ä¸­æ€§</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">ADX</div>
                                            <div id="adxValue" class="indicator-value fw-bold fs-5">0.0</div>
                                            <div id="adxStatus" class="indicator-status small mt-1">å¼±è¶‹åŠ¿</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">å¸ƒæ—å¸¦ä½ç½®</div>
                                            <div id="bbPosition" class="indicator-value fw-bold fs-5">-</div>
                                            <div id="bbStatus" class="indicator-status small mt-1">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">WMA</div>
                                            <div id="lineWMA" class="indicator-value fw-bold fs-5">0.00</div>
                                            <div class="indicator-status small mt-1">ç§»åŠ¨å¹³å‡</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">EMA</div>
                                            <div id="openEMA" class="indicator-value fw-bold fs-5">0.00</div>
                                            <div class="indicator-status small mt-1">æŒ‡æ•°å¹³å‡</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">ææ…ŒæŒ‡æ•°</div>
                                            <div id="vixFear" class="indicator-value fw-bold fs-5">20.0</div>
                                            <div id="vixStatus" class="indicator-status small mt-1">æ­£å¸¸</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-3">
                                        <div class="indicator-card text-center p-3 border rounded">
                                            <div class="indicator-label text-muted mb-1">è´ªå©ªæŒ‡æ•°</div>
                                            <div id="greedScore" class="indicator-value fw-bold fs-5">50</div>
                                            <div id="greedStatus" class="indicator-status small mt-1">ä¸­æ€§</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¿‡æ»¤çŠ¶æ€ -->
                    <div class="col-md-4 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-filter me-2"></i>è¿‡æ»¤çŠ¶æ€
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="filterStatus" class="filter-container">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <p>æš‚æ— è¿‡æ»¤ä¿¡æ¯</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¿¡å·åŸå› å’ŒAIåˆ†æ -->
                <div class="row">
                    <!-- ä¿¡å·åŸå›  -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>ä¿¡å·åŸå› 
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="signalReason" class="reason-container">
                                    <p class="text-muted mb-0">æš‚æ— ä¿¡å·åŸå› </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AIåˆ†æ -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-robot me-2"></i>AIåˆ†æ
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="deepseekAnalysis" class="analysis-container">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-robot fa-2x mb-2"></i>
                                        <p>æš‚æ— AIåˆ†ææ•°æ®</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ä¸»é¡µåˆå§‹åŒ–å¼€å§‹...');
    
    // ç«‹å³åŠ è½½æ•°æ®
    loadDashboardData();
    
    // åŠ è½½äº¤æ˜“æ¨¡å¼æ•°æ®
    loadTradingMode();
    
    // è‡ªåŠ¨åˆ·æ–°ä»ªè¡¨æ¿æ•°æ®
    setInterval(loadDashboardData, 15000); // æ¯15ç§’æ›´æ–°ä¸€æ¬¡
    

});

// åŠ è½½ä»ªè¡¨æ¿æ•°æ®
function loadDashboardData() {
    console.log('å¼€å§‹åŠ è½½ä»ªè¡¨æ¿æ•°æ®...');
    
    fetch('/api/dashboard')
        .then(response => response.json())
        .then(data => {
            console.log('è·å–åˆ°çš„ä»ªè¡¨æ¿æ•°æ®:', data);
            
            if (data.success) {
                updateDashboardDisplay(data.dashboard);
                // åŒæ—¶æ›´æ–°ä¿¡å·æ˜¾ç¤ºï¼Œé¿å…é‡å¤è°ƒç”¨API
                displayCompleteSignalInfo(data.dashboard);
            } else {
                console.error('è·å–ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', data.message);
                showError('è·å–ä»ªè¡¨æ¿æ•°æ®å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
            showError('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¼‚å¸¸: ' + error.message);
        });
}

// æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤º
function updateDashboardDisplay(dashboard) {
    try {
        // ä¿å­˜ä»ªè¡¨æ¿æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.currentDashboardData = dashboard;
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        const systemStatus = document.getElementById('systemStatus');
        if (systemStatus) {
            if (dashboard.system_running) {
                systemStatus.innerHTML = '<span class="badge bg-success">è¿è¡Œä¸­</span>';
            } else {
                systemStatus.innerHTML = '<span class="badge bg-danger">å·²åœæ­¢</span>';
            }
        }
        
        const runtimeHours = document.getElementById('runtimeHours');
        if (runtimeHours) {
            runtimeHours.textContent = dashboard.runtime_hours + 'å°æ—¶';
        }
        

        
        // æ›´æ–°ä»Šæ—¥æ”¶ç›Š
        const dailyPnL = document.getElementById('dailyPnL');
        if (dailyPnL) {
            const dailyPnLValue = dashboard.daily_pnl !== null && dashboard.daily_pnl !== undefined ? parseFloat(dashboard.daily_pnl) : 0;
            dailyPnL.textContent = '$' + dailyPnLValue.toLocaleString('en-US', {minimumFractionDigits: 2});
            dailyPnL.className = 'mb-0 ' + getPnLClass(dailyPnLValue);
        }
        
        const dailyReturn = document.getElementById('dailyReturn');
        if (dailyReturn) {
            const dailyReturnValue = dashboard.daily_return_percent !== null && dashboard.daily_return_percent !== undefined ? parseFloat(dashboard.daily_return_percent) : 0;
            dailyReturn.textContent = dailyReturnValue.toFixed(2) + '%';
        }
        
        // æ›´æ–°æ€»æ”¶ç›Š
        const totalPnL = document.getElementById('totalPnL');
        if (totalPnL) {
            const totalPnLValue = dashboard.total_pnl !== null && dashboard.total_pnl !== undefined ? parseFloat(dashboard.total_pnl) : 0;
            totalPnL.textContent = '$' + totalPnLValue.toLocaleString('en-US', {minimumFractionDigits: 2});
            totalPnL.className = 'mb-0 ' + getPnLClass(totalPnLValue);
        }
        
        const totalReturn = document.getElementById('totalReturn');
        if (totalReturn) {
            const totalReturnValue = dashboard.total_return_percent !== null && dashboard.total_return_percent !== undefined ? parseFloat(dashboard.total_return_percent) : 0;
            totalReturn.textContent = totalReturnValue.toFixed(2) + '%';
        }
        
        // æ›´æ–°è´¦æˆ·ä¿¡æ¯
        const currentCapital = document.getElementById('currentCapital');
        if (currentCapital) {
            const currentCapitalValue = dashboard.current_capital !== null && dashboard.current_capital !== undefined ? parseFloat(dashboard.current_capital) : 0;
            currentCapital.textContent = '$' + currentCapitalValue.toLocaleString('en-US', {minimumFractionDigits: 2});
        }
        
        const availableCapital = document.getElementById('availableCapital');
        if (availableCapital) {
            const availableCapitalValue = dashboard.available_capital !== null && dashboard.available_capital !== undefined ? parseFloat(dashboard.available_capital) : 0;
            availableCapital.textContent = '$' + availableCapitalValue.toLocaleString('en-US', {minimumFractionDigits: 2});
        }
        
        const capitalUtilization = document.getElementById('capitalUtilization');
        if (capitalUtilization) {
            const capitalUtilizationValue = dashboard.capital_utilization !== null && dashboard.capital_utilization !== undefined ? parseFloat(dashboard.capital_utilization) : 0;
            capitalUtilization.textContent = capitalUtilizationValue.toFixed(2) + '%';
        }
        
        // æ›´æ–°æŒä»“ä¿¡æ¯
        const positionStatus = document.getElementById('positionStatus');
        const positionIcon = document.getElementById('positionIcon');
        if (positionStatus && positionIcon) {
            if (dashboard.current_position !== 0) {
                positionStatus.textContent = 'æœ‰ä»“ä½';
                positionStatus.className = 'fw-bold text-success';
                positionIcon.className = 'fas fa-chart-line fa-2x text-success';
            } else {
                positionStatus.textContent = 'æ— ä»“ä½';
                positionStatus.className = 'fw-bold text-muted';
                positionIcon.className = 'fas fa-chart-line fa-2x text-muted';
            }
        }
        
        // æ›´æ–°è¯¦ç»†æŒä»“ä¿¡æ¯
        const positionQuantity = document.getElementById('positionQuantity');
        if (positionQuantity) {
            const quantity = dashboard.position_quantity || 0;
            positionQuantity.textContent = quantity.toFixed(4) + ' ETH';
        }
        
        const positionValue = document.getElementById('positionValue');
        if (positionValue) {
            const value = dashboard.position_value || 0;
            positionValue.textContent = '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2});
        }
        
        const positionUnrealizedPnL = document.getElementById('positionUnrealizedPnL');
        const positionUnrealizedPercent = document.getElementById('positionUnrealizedPercent');
        if (positionUnrealizedPnL && positionUnrealizedPercent) {
            const unrealizedPnL = dashboard.position_unrealized_pnl || 0;
            const unrealizedPnLPercent = dashboard.position_unrealized_pnl_percent || 0;
            positionUnrealizedPnL.textContent = '$' + unrealizedPnL.toLocaleString('en-US', {minimumFractionDigits: 2});
            positionUnrealizedPercent.textContent = '(' + unrealizedPnLPercent.toFixed(2) + '%)';
            
            // è®¾ç½®é¢œè‰²
            if (unrealizedPnL > 0) {
                positionUnrealizedPnL.className = 'h5 mb-0 text-success';
                positionUnrealizedPercent.className = 'text-muted text-success';
            } else if (unrealizedPnL < 0) {
                positionUnrealizedPnL.className = 'h5 mb-0 text-danger';
                positionUnrealizedPercent.className = 'text-muted text-danger';
            } else {
                positionUnrealizedPnL.className = 'h5 mb-0 text-muted';
                positionUnrealizedPercent.className = 'text-muted';
            }
        }
        
        const tradingModeStatus = document.getElementById('tradingModeStatus');
        if (tradingModeStatus) {
            if (dashboard.real_trading) {
                tradingModeStatus.textContent = 'çœŸå®äº¤æ˜“';
                tradingModeStatus.className = 'h4 mb-0 text-danger fw-bold';
            } else {
                tradingModeStatus.textContent = 'æ¨¡æ‹Ÿäº¤æ˜“';
                tradingModeStatus.className = 'h4 mb-0 text-warning fw-bold';
            }
        }
        
        // æ›´æ–°äº¤æ˜“ç»Ÿè®¡
        const totalTrades = document.getElementById('totalTrades');
        if (totalTrades) {
            totalTrades.textContent = dashboard.total_trades;
        }
        
        const dailyTrades = document.getElementById('dailyTrades');
        if (dailyTrades) {
            dailyTrades.textContent = dashboard.daily_trades;
        }
        
        const winRate = document.getElementById('winRate');
        if (winRate) {
            const winRateValue = dashboard.win_rate !== null && dashboard.win_rate !== undefined ? parseFloat(dashboard.win_rate) : 0;
            winRate.textContent = winRateValue.toFixed(1) + '%';
        }
        
        const winningTrades = document.getElementById('winningTrades');
        if (winningTrades) {
            winningTrades.textContent = dashboard.winning_trades;
        }
        
        const losingTrades = document.getElementById('losingTrades');
        if (losingTrades) {
            losingTrades.textContent = dashboard.losing_trades;
        }
        
        console.log('ä»ªè¡¨æ¿æ•°æ®æ›´æ–°å®Œæˆ');
    } catch (error) {
        console.error('æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤ºå¤±è´¥:', error);
    }
}



// è·å–ä¿¡å·æ ·å¼ç±»
function getSignalClass(signal) {
    switch (signal) {
        case 1: return 'bg-success';  // åšå¤šä¿¡å·
        case -1: return 'bg-danger';  // åšç©ºä¿¡å·
        default: return 'bg-secondary';   // æ— ä¿¡å·
    }
}

// è·å–ä¿¡å·æ–‡æœ¬æè¿°
function getSignalText(signal) {
    switch (signal) {
        case 1: return 'åšå¤šä¿¡å·';  // åšå¤šä¿¡å·
        case -1: return 'åšç©ºä¿¡å·';  // åšç©ºä¿¡å·
        default: return 'æ— ä¿¡å·';   // æ— ä¿¡å·
    }
}

// æ˜¾ç¤ºå®Œæ•´ä¿¡å·ä¿¡æ¯
function displayCompleteSignalInfo(dashboard) {
    const completeSignalInfo = dashboard.complete_signal_info || {};
    
    // æ›´æ–°ä¿¡å·æ¦‚è§ˆ
    updateSignalOverview(completeSignalInfo);
    
    // æ›´æ–°æŠ€æœ¯æŒ‡æ ‡
    updateTechnicalIndicators(completeSignalInfo);
    
    // æ›´æ–°è¿‡æ»¤çŠ¶æ€
    updateFilterStatus(completeSignalInfo);
    
    // æ›´æ–°ä¿¡å·åŸå› 
    updateSignalReason(completeSignalInfo);
    
    // æ›´æ–°AIåˆ†æ
    updateDeepSeekAnalysis(completeSignalInfo);
    
    // æ›´æ–°æ—¶é—´æˆ³
    updateSignalTimestamp();
}

// æ›´æ–°ä¿¡å·æ¦‚è§ˆ
function updateSignalOverview(signalInfo) {
    const signal = signalInfo.signal || 0;
    const signalText = getSignalText(signal);
    const signalClass = getSignalClass(signal);
    
    // æ›´æ–°ä¿¡å·å›¾æ ‡å’Œç±»å‹
    const signalIcon = document.getElementById('signalIcon');
    const signalType = document.getElementById('signalType');
    if (signalIcon && signalType) {
        if (signal === 1) {
            signalIcon.className = 'fas fa-arrow-up fa-3x text-success';
            signalType.textContent = 'åšå¤šä¿¡å·';
        } else if (signal === -1) {
            signalIcon.className = 'fas fa-arrow-down fa-3x text-danger';
            signalType.textContent = 'åšç©ºä¿¡å·';
        } else {
            signalIcon.className = 'fas fa-minus fa-3x text-secondary';
            signalType.textContent = 'è§‚æœ›ä¿¡å·';
        }
    }
    
    // æ›´æ–°æ—¶é—´
    const signalTime = document.getElementById('signalTime');
    if (signalTime) {
        const timestamp = signalInfo.timestamp;
        if (timestamp) {
            const date = new Date(timestamp);
            signalTime.textContent = date.toLocaleString('zh-CN');
        } else {
            signalTime.textContent = '-';
        }
    }
    
    // æ›´æ–°ä»·æ ¼ä¿¡æ¯
    const signalPrice = document.getElementById('signalPrice');
    const signalSymbol = document.getElementById('signalSymbol');
    if (signalPrice) {
        let price = signalInfo.price || signalInfo.current_price || 0;
        
        // æ•°æ®éªŒè¯ï¼šç¡®ä¿priceæ˜¯æœ‰æ•ˆæ•°å€¼
        if (isNaN(price) || price === null || price === undefined) {
            price = 0;
            console.warn('ä»·æ ¼æ•°æ®æ— æ•ˆï¼Œè®¾ç½®ä¸º0');
        }
        
        signalPrice.textContent = '$' + price.toFixed(2);
    }
    if (signalSymbol) {
        signalSymbol.textContent = signalInfo.symbol || 'ETHUSDT';
    }
    
    // æ›´æ–°è¯„åˆ†ä¿¡æ¯
    const signalScoreMain = document.getElementById('signalScoreMain');
    const signalStrength = document.getElementById('signalStrength');
    if (signalScoreMain) {
        const score = signalInfo.signal_score || 0;
        signalScoreMain.textContent = score.toFixed(3);
        signalScoreMain.className = 'mb-0 score-number ' + getScoreClass(score);
    }
    if (signalStrength) {
        const score = Math.abs(signalInfo.signal_score || 0);
        let strength = 'å¼±';
        if (score > 0.5) strength = 'å¼º';
        else if (score > 0.2) strength = 'ä¸­ç­‰';
        signalStrength.textContent = 'å¼ºåº¦: ' + strength;
    }
    
    // æ›´æ–°è¶‹åŠ¿è¯„åˆ†
    const trendScoreMain = document.getElementById('trendScoreMain');
    const trendStatus = document.getElementById('trendStatus');
    if (trendScoreMain) {
        const trendScore = signalInfo.trend_score || 0;
        trendScoreMain.textContent = trendScore.toFixed(3);
        trendScoreMain.className = 'mb-0 score-number ' + getScoreClass(trendScore);
    }
    if (trendStatus) {
        const trendScore = signalInfo.trend_score || 0;
        let status = 'ä¸­æ€§';
        if (trendScore > 0.3) status = 'çœ‹æ¶¨';
        else if (trendScore < -0.3) status = 'çœ‹è·Œ';
        trendStatus.textContent = status;
    }
    
    // æ›´æ–°é£é™©è¯„åˆ†
    const riskScoreMain = document.getElementById('riskScoreMain');
    const riskStatus = document.getElementById('riskStatus');
    if (riskScoreMain) {
        const riskScore = signalInfo.risk_score || 0;
        riskScoreMain.textContent = riskScore.toFixed(3);
        riskScoreMain.className = 'mb-0 score-number ' + getScoreClass(riskScore);
    }
    if (riskStatus) {
        const riskScore = Math.abs(signalInfo.risk_score || 0);
        let status = 'ä½é£é™©';
        if (riskScore > 0.5) status = 'é«˜é£é™©';
        else if (riskScore > 0.3) status = 'ä¸­é£é™©';
        riskStatus.textContent = status;
    }
    
    // æ›´æ–°ä»“ä½ä¿¡æ¯
    const signalPosition = document.getElementById('signalPosition');
    const signalDirection = document.getElementById('signalDirection');
    if (signalPosition) {
        let positionSize = signalInfo.position_size || 0;
        
        // å¤„ç†position_sizeå¯èƒ½æ˜¯å¯¹è±¡çš„æƒ…å†µ
        if (typeof positionSize === 'object' && positionSize !== null) {
            positionSize = positionSize.size || 0;
        }
        
        // ç¡®ä¿positionSizeæ˜¯æœ‰æ•ˆæ•°å€¼
        if (isNaN(positionSize) || positionSize === null || positionSize === undefined) {
            positionSize = 0;
        }
        
        // è½¬æ¢ä¸ºç™¾åˆ†æ¯”å¹¶æ˜¾ç¤º
        const percentage = (positionSize * 100).toFixed(1);
        signalPosition.textContent = percentage + '%';
    }
    if (signalDirection) {
        let direction = 'è§‚æœ›';
        if (signal === 1) direction = 'åšå¤š';
        else if (signal === -1) direction = 'åšç©º';
        signalDirection.textContent = 'æ–¹å‘: ' + direction;
    }
}



// æ›´æ–°æŠ€æœ¯æŒ‡æ ‡
function updateTechnicalIndicators(signalInfo) {
    const indicators = signalInfo.indicators || {};
    
    // æ›´æ–°RSI
    const rsiValue = document.getElementById('rsiValue');
    const rsiStatus = document.getElementById('rsiStatus');
    if (rsiValue) {
        const rsi = indicators.rsi || 0;
        rsiValue.textContent = rsi.toFixed(1);
        rsiValue.className = 'indicator-value fw-bold fs-5 ' + getRSIClass(rsi);
        
        // æ·»åŠ æ•°å€¼å¼ºè°ƒæ•ˆæœ
        if (rsi > 70 || rsi < 30) {
            rsiValue.style.fontWeight = '900';
            rsiValue.style.textShadow = '2px 2px 4px rgba(0,0,0,0.3)';
        } else {
            rsiValue.style.fontWeight = '700';
            rsiValue.style.textShadow = '1px 1px 2px rgba(0,0,0,0.1)';
        }
    }
    if (rsiStatus) {
        const rsi = indicators.rsi || 0;
        if (rsi > 70) rsiStatus.textContent = 'è¶…ä¹°';
        else if (rsi < 30) rsiStatus.textContent = 'è¶…å–';
        else rsiStatus.textContent = 'æ­£å¸¸';
        rsiStatus.className = 'indicator-status small mt-1 ' + getRSIClass(rsi);
    }
    
    // æ›´æ–°MACD
    const macdValue = document.getElementById('macdValue');
    const macdStatus = document.getElementById('macdStatus');
    if (macdValue) {
        const macd = indicators.macd || 0;
        macdValue.textContent = macd.toFixed(2);
        macdValue.className = 'indicator-value fw-bold fs-5 ' + getMACDClass(macd);
    }
    if (macdStatus) {
        const macd = indicators.macd || 0;
        if (macd > 0) macdStatus.textContent = 'çœ‹æ¶¨';
        else if (macd < 0) macdStatus.textContent = 'çœ‹è·Œ';
        else macdStatus.textContent = 'ä¸­æ€§';
        macdStatus.className = 'indicator-status small mt-1 ' + getMACDClass(macd);
    }
    
    // æ›´æ–°ADX
    const adxValue = document.getElementById('adxValue');
    const adxStatus = document.getElementById('adxStatus');
    if (adxValue) {
        const adx = indicators.adx || 0;
        adxValue.textContent = adx.toFixed(1);
        adxValue.className = 'indicator-value fw-bold fs-5 ' + getADXClass(adx);
    }
    if (adxStatus) {
        const adx = indicators.adx || 0;
        if (adx > 25) adxStatus.textContent = 'å¼ºè¶‹åŠ¿';
        else if (adx > 20) adxStatus.textContent = 'ä¸­ç­‰è¶‹åŠ¿';
        else adxStatus.textContent = 'å¼±è¶‹åŠ¿';
        adxStatus.className = 'indicator-status small mt-1 ' + getADXClass(adx);
    }
    
    // æ›´æ–°å¸ƒæ—å¸¦ä½ç½®
    const bbPosition = document.getElementById('bbPosition');
    const bbStatus = document.getElementById('bbStatus');
    if (bbPosition) {
        const bb_pos = indicators.bb_position || 0.5;
        bbPosition.textContent = bb_pos.toFixed(2);
    }
    if (bbStatus) {
        const bb_pos = indicators.bb_position || 0.5;
        if (bb_pos > 0.8) bbStatus.textContent = 'ä¸Šè½¨';
        else if (bb_pos < 0.2) bbStatus.textContent = 'ä¸‹è½¨';
        else bbStatus.textContent = 'ä¸­è½¨';
    }
    
    // æ›´æ–°å…¶ä»–æŒ‡æ ‡
    const lineWMA = document.getElementById('lineWMA');
    if (lineWMA) {
        const wma = indicators.lineWMA || 0;
        lineWMA.textContent = wma.toFixed(2);
    }
    
    const openEMA = document.getElementById('openEMA');
    if (openEMA) {
        const ema = indicators.openEMA || 0;
        openEMA.textContent = ema.toFixed(2);
    }
    
    // æ›´æ–°ææ…ŒæŒ‡æ•°
    const vixFear = document.getElementById('vixFear');
    const vixStatus = document.getElementById('vixStatus');
    if (vixFear) {
        const vix = indicators.vix_fear || 20.0;
        vixFear.textContent = vix.toFixed(1);
    }
    if (vixStatus) {
        const vix = indicators.vix_fear || 20.0;
        if (vix > 30) vixStatus.textContent = 'ææ…Œ';
        else if (vix < 15) vixStatus.textContent = 'è´ªå©ª';
        else vixStatus.textContent = 'æ­£å¸¸';
    }
    
    // æ›´æ–°è´ªå©ªæŒ‡æ•°
    const greedScore = document.getElementById('greedScore');
    const greedStatus = document.getElementById('greedStatus');
    if (greedScore) {
        const greed = indicators.greed_score || 50;
        greedScore.textContent = greed;
    }
    if (greedStatus) {
        const greed = indicators.greed_score || 50;
        if (greed > 70) greedStatus.textContent = 'è´ªå©ª';
        else if (greed < 30) greedStatus.textContent = 'ææ…Œ';
        else greedStatus.textContent = 'ä¸­æ€§';
    }
}

// æ›´æ–°è¿‡æ»¤çŠ¶æ€
function updateFilterStatus(signalInfo) {
    const filterStatus = document.getElementById('filterStatus');
    if (!filterStatus) return;
    
    const filterInfo = signalInfo.filter_info || {};
    
    if (Object.keys(filterInfo).length === 0) {
        filterStatus.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>æš‚æ— è¿‡æ»¤ä¿¡æ¯</p>
            </div>
        `;
    } else {
        let filterHtml = '<div class="filter-list">';
        for (const [filterName, filterData] of Object.entries(filterInfo)) {
            const passed = filterData.passed;
            const reason = filterData.reason || '';
            const badgeClass = passed ? 'bg-success' : 'bg-danger';
            const icon = passed ? 'fas fa-check' : 'fas fa-times';
            const statusText = passed ? 'é€šè¿‡' : 'å¤±è´¥';
            
            filterHtml += `
                <div class="filter-item d-flex align-items-center mb-2 p-2 border rounded">
                    <i class="${icon} ${badgeClass} me-2"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${filterName}</div>
                        <small class="text-muted">${reason}</small>
                    </div>
                    <span class="badge ${badgeClass}">${statusText}</span>
                </div>
            `;
        }
        filterHtml += '</div>';
        filterStatus.innerHTML = filterHtml;
    }
}

// æ›´æ–°ä¿¡å·åŸå› 
function updateSignalReason(signalInfo) {
    const signalReason = document.getElementById('signalReason');
    if (!signalReason) return;
    
    const reason = signalInfo.reason || 'æš‚æ— ä¿¡å·åŸå› ';
    
    if (reason === 'æš‚æ— ä¿¡å·åŸå› ') {
        signalReason.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-lightbulb fa-2x mb-2"></i>
                <p>æš‚æ— ä¿¡å·åŸå› </p>
            </div>
        `;
    } else {
        signalReason.innerHTML = `
            <div class="reason-content">
                <p class="mb-0 text-dark">${reason}</p>
            </div>
        `;
    }
}

// æ›´æ–°DeepSeekåˆ†æ
function updateDeepSeekAnalysis(signalInfo) {
    const deepseekAnalysis = document.getElementById('deepseekAnalysis');
    if (!deepseekAnalysis) return;
    
    const analysis = signalInfo.deepseek_analysis || {};
    
    if (Object.keys(analysis).length === 0) {
        deepseekAnalysis.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-robot fa-2x mb-2"></i>
                <p>æš‚æ— AIåˆ†ææ•°æ®</p>
            </div>
        `;
    } else {
        let analysisHtml = '<div class="analysis-content">';
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        if (analysis.advice) {
            analysisHtml += `
                <div class="analysis-item mb-3">
                    <h6 class="text-primary">æŠ•èµ„å»ºè®®</h6>
                    <p class="mb-0">${analysis.advice}</p>
                </div>
            `;
        }
        
        if (analysis.trend) {
            analysisHtml += `
                <div class="analysis-item mb-3">
                    <h6 class="text-info">è¶‹åŠ¿åˆ†æ</h6>
                    <p class="mb-0">${analysis.trend}</p>
                </div>
            `;
        }
        
        if (analysis.risk) {
            analysisHtml += `
                <div class="analysis-item mb-3">
                    <h6 class="text-warning">é£é™©è¯„ä¼°</h6>
                    <p class="mb-0">${analysis.risk}</p>
                </div>
            `;
        }
        
        analysisHtml += '</div>';
        deepseekAnalysis.innerHTML = analysisHtml;
    }
}

// æ›´æ–°æ—¶é—´æˆ³
function updateSignalTimestamp() {
    const signalUpdateTime = document.getElementById('signalUpdateTime');
    if (signalUpdateTime) {
        const now = new Date();
        signalUpdateTime.textContent = now.toLocaleTimeString('zh-CN');
    }
}

// åˆ·æ–°ä¿¡å·è¯¦æƒ…
function refreshSignalDetails() {
    console.log('æ‰‹åŠ¨åˆ·æ–°ä¿¡å·è¯¦æƒ…...');
    loadDashboardData();
}

// è·å–è¯„åˆ†æ ·å¼ç±»
function getScoreClass(score) {
    if (score > 0.5) return 'text-success';
    if (score > 0.2) return 'text-warning';
    if (score < -0.5) return 'text-danger';
    if (score < -0.2) return 'text-warning';
    return 'text-muted';
}



// è·å–RSIæ ·å¼ç±»
function getRSIClass(rsi) {
    if (rsi > 70) return 'text-danger';  // è¶…ä¹°
    if (rsi < 30) return 'text-success'; // è¶…å–
    return 'text-muted';
}

// è·å–MACDæ ·å¼ç±»
function getMACDClass(macd) {
    if (macd > 0) return 'text-success';  // æ­£å€¼
    if (macd < 0) return 'text-danger';   // è´Ÿå€¼
    return 'text-muted';
}

// è·å–ADXæ ·å¼ç±»
function getADXClass(adx) {
    if (adx > 25) return 'text-success';  // å¼ºè¶‹åŠ¿
    if (adx > 20) return 'text-warning';  // ä¸­ç­‰è¶‹åŠ¿
    return 'text-muted';                  // å¼±è¶‹åŠ¿
}

// è·å–ç›ˆäºæ ·å¼ç±»
function getPnLClass(pnl) {
    if (pnl > 0) return 'text-success';
    if (pnl < 0) return 'text-danger';
    return 'text-warning';
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    if (typeof utils !== 'undefined' && utils.showMessage) {
        utils.showMessage(message, 'danger');
    } else {
        console.error(message);
    }
}

// æ›´æ–°äº¤æ˜“æ¨¡å¼æ˜¾ç¤ºï¼ˆä¸»é¡µç‰ˆæœ¬ï¼‰
function updateTradingModeDisplayMain(modeData) {
    const modeIcon = document.getElementById('trading_mode_icon_main');
    const modeText = document.getElementById('trading_mode_text_main');
    const modeWarning = document.getElementById('trading_mode_warning_main');
    const realModeBtn = document.getElementById('real_mode_btn_main');
    const simulationModeBtn = document.getElementById('simulation_mode_btn_main');
    
    if (modeIcon) modeIcon.textContent = modeData.mode_icon || 'ğŸŸ¡';
    if (modeText) modeText.textContent = modeData.trading_mode || 'æ¨¡æ‹Ÿäº¤æ˜“';
    if (modeWarning) modeWarning.textContent = modeData.warning_message || '';
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (realModeBtn) {
        realModeBtn.disabled = !modeData.can_switch_to_real;
        realModeBtn.classList.toggle('active', modeData.real_trading);
    }
    if (simulationModeBtn) {
        simulationModeBtn.classList.toggle('active', !modeData.real_trading);
    }
}

// åŠ è½½äº¤æ˜“æ¨¡å¼
function loadTradingMode() {
    fetch('/api/trading_mode')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTradingModeDisplayMain(data.mode);
            }
        })
        .catch(error => {
            console.error('è·å–äº¤æ˜“æ¨¡å¼å¤±è´¥:', error);
        });
}

// åˆ‡æ¢äº¤æ˜“æ¨¡å¼
function switchTradingMode(mode) {
    const modeText = mode === 'real' ? 'çœŸå®äº¤æ˜“' : 'æ¨¡æ‹Ÿäº¤æ˜“';
    
    if (confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°${modeText}æ¨¡å¼å—ï¼Ÿ`)) {
        fetch('/api/trading_mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ mode: mode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                utils.showMessage(`å·²åˆ‡æ¢åˆ°${modeText}æ¨¡å¼`, 'success');
                // é‡æ–°åŠ è½½äº¤æ˜“æ¨¡å¼æ•°æ®
                loadTradingMode();
                // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ‰€æœ‰ç›¸å…³æ•°æ®
                setTimeout(() => location.reload(), 1000);
            } else {
                utils.showMessage(`åˆ‡æ¢å¤±è´¥: ${data.message}`, 'danger');
            }
        })
        .catch(error => {
            console.error('åˆ‡æ¢äº¤æ˜“æ¨¡å¼å¤±è´¥:', error);
            utils.showMessage('åˆ‡æ¢äº¤æ˜“æ¨¡å¼å¼‚å¸¸: ' + error.message, 'danger');
        });
    }
}

// å¯åŠ¨ç³»ç»Ÿ
function startSystem() {
    fetch('/api/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                utils.showMessage('ç³»ç»Ÿå¯åŠ¨æˆåŠŸ', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                utils.showMessage('å¯åŠ¨å¤±è´¥: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            utils.showMessage('å¯åŠ¨å¼‚å¸¸: ' + error.message, 'danger');
        });
}

// åœæ­¢ç³»ç»Ÿ
function stopSystem() {
    if (confirm('ç¡®å®šè¦åœæ­¢ç³»ç»Ÿå—ï¼Ÿ')) {
        fetch('/api/stop', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    utils.showMessage('ç³»ç»Ÿåœæ­¢æˆåŠŸ', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    utils.showMessage('åœæ­¢å¤±è´¥: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                utils.showMessage('åœæ­¢å¼‚å¸¸: ' + error.message, 'danger');
            });
    }
}
</script>

<style>
/* è¯„åˆ†æ˜¾ç¤ºå¢å¼ºæ ·å¼ */
.score-number {
    font-weight: 700 !important;
    font-size: 1.8rem !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    margin-bottom: 8px !important;
    letter-spacing: 1px;
}

/* è¯„åˆ†é¢œè‰²å¢å¼º */
.score-number.text-success {
    color: #28a745 !important;
    text-shadow: 1px 1px 3px rgba(40, 167, 69, 0.4);
}

.score-number.text-warning {
    color: #ffc107 !important;
    text-shadow: 1px 1px 3px rgba(255, 193, 7, 0.4);
}

.score-number.text-danger {
    color: #dc3545 !important;
    text-shadow: 1px 1px 3px rgba(220, 53, 69, 0.4);
}

.score-number.text-muted {
    color: #6c757d !important;
    text-shadow: 1px 1px 3px rgba(108, 117, 125, 0.4);
}

/* ä¿¡å·è¯¦æƒ…å¡ç‰‡å¢å¼º */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* æŠ€æœ¯æŒ‡æ ‡å¡ç‰‡å¢å¼º */
.indicator-card {
    transition: all 0.3s ease;
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border: 1px solid #dee2e6;
}

.indicator-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.indicator-value {
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .score-number {
        font-size: 1.5rem !important;
    }
}
</style>
{% endblock %}