{% extends "base.html" %}

{% block title %}ç³»ç»Ÿé…ç½® - äº¤æ˜“ç³»ç»Ÿ{% endblock %}
{% block page_title %}ç³»ç»Ÿé…ç½®{% endblock %}

{% block extra_css %}
<style>
/* ä¼˜åŒ–é…ç½®é¡µé¢æ€§èƒ½ */
.config-container {
    will-change: transform;
}

.form-range {
    transition: none; /* ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œæé«˜å“åº”é€Ÿåº¦ */
}

.btn:disabled {
    pointer-events: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// é˜²æ­¢é‡å¤åˆå§‹åŒ–çš„æ ‡å¿—
let configLoaded = false;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– - ä¼˜åŒ–ç‰ˆæœ¬
document.addEventListener('DOMContentLoaded', function() {
    if (!configLoaded) {
        // ç«‹å³åˆå§‹åŒ–å‡½æ•°ï¼Œç„¶åå¼‚æ­¥åŠ è½½é…ç½®
        initConfigFunctions();
        
        // ä½¿ç”¨setTimeoutå»¶è¿ŸåŠ è½½é…ç½®ï¼Œè®©é¡µé¢å…ˆæ¸²æŸ“å®Œæˆ
        setTimeout(() => {
            loadAllConfig().then(() => {
                configLoaded = true;
            }).catch(error => {
                console.error('é…ç½®é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
            });
        }, 100);
    }
});

// åˆå§‹åŒ–é…ç½®å‡½æ•°
function initConfigFunctions() {
    // å®šä¹‰å…¨å±€å‡½æ•°
    window.saveAllConfig = function() {
        
        // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
        const saveBtn = document.querySelector('button[onclick="saveAllConfig()"]');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
        saveBtn.disabled = true;
        
        // å¿«é€Ÿæ”¶é›†é…ç½®æ•°æ®
        const configData = {
            trading: {
                symbol: document.getElementById('symbol').value,
                timeframe: document.getElementById('timeframe').value,
            },
            capital_management: {
                initial_capital: parseFloat(document.getElementById('initial_capital').value),
                position_size_percent: parseFloat(document.getElementById('position_size_percent').value),
                leverage: parseInt(document.getElementById('leverage').value)
            },
            position_management: {
                max_position_size: parseFloat(document.getElementById('max_position_size').value),
                min_position_size: parseFloat(document.getElementById('min_position_size').value)
            },
        };
        
        // å‡å°‘è¶…æ—¶æ—¶é—´ï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 5000)
        );
        
        const savePromise = fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(configData)
        }).then(response => {
            return response.json();
        });
        
        Promise.race([savePromise, timeoutPromise])
        .then(data => {
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            if (data.success) {
                // æ˜¾ç¤ºè¯¦ç»†çš„æ›´æ–°ä¿¡æ¯
                let message = 'é…ç½®ä¿å­˜æˆåŠŸ';
                if (data.updated_fields && data.updated_fields.length > 0) {
                    const updateInfo = data.updated_fields.join(', ');
                    message += `ï¼Œå·²åŒæ­¥æ›´æ–°ç­–ç•¥æ•°æ®: ${updateInfo}`;
                }
                
                if (typeof utils !== 'undefined' && utils.showMessage) {
                    utils.showMessage(message, 'success');
                } else {
                    alert(message);
                }
                
                // ç«‹å³æ›´æ–°å½“å‰æ˜¾ç¤º
                updateCurrentPositionDisplay();
            } else {
                if (typeof utils !== 'undefined' && utils.showMessage) {
                    utils.showMessage('é…ç½®ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
                } else {
                    alert('é…ç½®ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            }
        })
        .catch(error => {
            console.error('ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯:', error);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            const errorMessage = error.message === 'è¯·æ±‚è¶…æ—¶' ? 'ä¿å­˜è¶…æ—¶ï¼Œè¯·é‡è¯•' : 'é…ç½®ä¿å­˜å¼‚å¸¸: ' + error.message;
            
            if (typeof utils !== 'undefined' && utils.showMessage) {
                utils.showMessage(errorMessage, 'danger');
            } else {
                alert(errorMessage);
            }
        });
    };


    
}



// åŠ è½½æ‰€æœ‰é…ç½®æ•°æ® - ä¼˜åŒ–ç‰ˆæœ¬
function loadAllConfig() {
    
    // å‡å°‘è¶…æ—¶æ—¶é—´ï¼ŒåŠ å¿«å“åº”
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 5000)
    );
    
    const loadPromise = fetch('/api/config')
        .then(response => response.json())
        .then(data => {
            // æ‰¹é‡æ›´æ–°DOMï¼Œå‡å°‘é‡ç»˜æ¬¡æ•°
            requestAnimationFrame(() => {
                // å¿«é€Ÿè®¾ç½®äº¤æ˜“é…ç½®
                if (data.trading) {
                    if (data.trading.symbol) {
                        document.getElementById('symbol').value = data.trading.symbol;
                    }
                    if (data.trading.timeframe) {
                        document.getElementById('timeframe').value = data.trading.timeframe;
                    }
                }
                
                // å¿«é€Ÿè®¾ç½®èµ„é‡‘ç®¡ç†é…ç½®
                if (data.capital_management) {
                    if (data.capital_management.initial_capital) {
                        document.getElementById('initial_capital').value = data.capital_management.initial_capital;
                    }
                    if (data.capital_management.position_size_percent) {
                        document.getElementById('position_size_percent').value = data.capital_management.position_size_percent;
                    }
                    if (data.capital_management.leverage) {
                        const leverageElement = document.getElementById('leverage');
                        if (leverageElement) {
                            leverageElement.value = data.capital_management.leverage;
                        }
                    }
                }
                
                // å¿«é€Ÿè®¾ç½®ä»“ä½ç®¡ç†é…ç½®
                if (data.position_management) {
                    if (data.position_management.max_position_size) {
                        document.getElementById('max_position_size').value = data.position_management.max_position_size;
                    }
                    if (data.position_management.min_position_size) {
                        document.getElementById('min_position_size').value = data.position_management.min_position_size;
                    }
                }
                
                // è®¾ç½®äº¤æ˜“æ¨¡å¼é…ç½®
                if (data.trading_mode) {
                    updateTradingModeDisplay(data.trading_mode);
                }
                
                // ç«‹å³æ›´æ–°å½“å‰è®¾ç½®æ˜¾ç¤º
                updateCurrentPositionDisplay();
            });
        });
    
    return Promise.race([loadPromise, timeoutPromise])
        .catch(error => {
            console.error('åŠ è½½é…ç½®æ•°æ®å¤±è´¥:', error);
            const errorMessage = error.message === 'åŠ è½½è¶…æ—¶' ? 'é…ç½®åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•' : 'é…ç½®åŠ è½½å¤±è´¥: ' + error.message;
            
            if (typeof utils !== 'undefined' && utils.showMessage) {
                utils.showMessage(errorMessage, 'warning');
            } else {
                console.warn(errorMessage);
            }
            throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
        });
}

// æ›´æ–°å½“å‰è®¾ç½®æ˜¾ç¤º
function updateCurrentPositionDisplay() {
    const positionSize = document.getElementById('position_size_percent').value;
    const maxPosition = document.getElementById('max_position_size').value;
    const minPosition = document.getElementById('min_position_size').value;
    
    document.getElementById('current_position_size').textContent = (parseFloat(positionSize) * 100).toFixed(0) + '%';
    document.getElementById('current_max_position').textContent = (parseFloat(maxPosition) * 100).toFixed(0) + '%';
    document.getElementById('current_min_position').textContent = (parseFloat(minPosition) * 100).toFixed(0) + '%';
}

// æ›´æ–°äº¤æ˜“æ¨¡å¼æ˜¾ç¤º
function updateTradingModeDisplay(modeData) {
    const modeIcon = document.getElementById('trading_mode_icon');
    const modeText = document.getElementById('trading_mode_text');
    const modeWarning = document.getElementById('trading_mode_warning');
    const realModeBtn = document.getElementById('real_mode_btn');
    const simulationModeBtn = document.getElementById('simulation_mode_btn');
    
    if (modeIcon) modeIcon.textContent = modeData.mode_icon || 'ğŸŸ¡';
    if (modeText) modeText.textContent = modeData.trading_mode || 'æ¨¡æ‹Ÿäº¤æ˜“';
    if (modeWarning) modeWarning.textContent = modeData.warning_message || '';
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (realModeBtn) {
        realModeBtn.disabled = !modeData.can_switch_to_real;
        realModeBtn.classList.toggle('active', modeData.real_trading);
    }
    if (simulationModeBtn) {
        simulationModeBtn.classList.toggle('active', !modeData.real_trading);
    }
}

// åˆ‡æ¢äº¤æ˜“æ¨¡å¼
function switchTradingMode(mode) {
    const modeText = mode === 'real' ? 'çœŸå®äº¤æ˜“' : 'æ¨¡æ‹Ÿäº¤æ˜“';
    
    if (mode === 'real') {
        if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°${modeText}æ¨¡å¼å—ï¼Ÿ\n\nçœŸå®äº¤æ˜“æ¨¡å¼å°†ä½¿ç”¨çœŸå®èµ„é‡‘ï¼Œè¯·è°¨æ…æ“ä½œï¼`)) {
            return;
        }
    }
    
    fetch('/api/trading_mode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ mode: mode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof utils !== 'undefined' && utils.showMessage) {
                utils.showMessage(data.message, 'success');
            } else {
                alert(data.message);
            }
            // æ›´æ–°æ˜¾ç¤º
            updateTradingModeDisplay(data.mode);
        } else {
            if (typeof utils !== 'undefined' && utils.showMessage) {
                utils.showMessage('åˆ‡æ¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
            } else {
                alert('åˆ‡æ¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }
    })
    .catch(error => {
        console.error('åˆ‡æ¢äº¤æ˜“æ¨¡å¼æ—¶å‘ç”Ÿé”™è¯¯:', error);
        if (typeof utils !== 'undefined' && utils.showMessage) {
            utils.showMessage('åˆ‡æ¢å¼‚å¸¸: ' + error.message, 'danger');
        } else {
            alert('åˆ‡æ¢å¼‚å¸¸: ' + error.message);
        }
    });
}

// æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°æ˜¾ç¤º - ä¼˜åŒ–ç‰ˆæœ¬
document.addEventListener('DOMContentLoaded', function() {
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
    const configContainer = document.querySelector('.card-body');
    if (configContainer) {
        configContainer.addEventListener('input', function(event) {
            const target = event.target;
            if (target.id === 'position_size_percent' || 
                target.id === 'max_position_size' || 
                target.id === 'min_position_size') {
                // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹æ›´æ–°
                clearTimeout(target.updateTimeout);
                target.updateTimeout = setTimeout(updateCurrentPositionDisplay, 100);
            }
        });
    }
    

});
</script>
{% endblock %}

{% block content %}
<!-- é…ç½®é€‰é¡¹å¡ -->
<div class="row">
    <div class="col-12">
        <div class="card config-container">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading" type="button" role="tab">
                            <i class="fas fa-chart-line me-1"></i>äº¤æ˜“é…ç½®
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="capital-tab" data-bs-toggle="tab" data-bs-target="#capital" type="button" role="tab">
                            <i class="fas fa-dollar-sign me-1"></i>èµ„é‡‘ç®¡ç†
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="position-tab" data-bs-toggle="tab" data-bs-target="#position" type="button" role="tab">
                            <i class="fas fa-chart-pie me-1"></i>ä»“ä½ç®¡ç†
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mode-tab" data-bs-toggle="tab" data-bs-target="#mode" type="button" role="tab">
                            <i class="fas fa-toggle-on me-1"></i>è¿è¡Œæ¨¡å¼
                        </button>
                    </li>


                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="configTabContent">
                    <!-- äº¤æ˜“é…ç½® -->
                    <div class="tab-pane fade show active" id="trading" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-line me-2"></i>åŸºæœ¬äº¤æ˜“è®¾ç½®</h6>
                                <div class="mb-3">
                                    <label for="symbol" class="form-label">äº¤æ˜“å¯¹</label>
                                    <select class="form-select" id="symbol" name="symbol">
                                        <option value="ETHUSDT">ETHUSDT</option>
                                        <option value="BTCUSDT">BTCUSDT</option>
                                        <option value="BNBUSDT">BNBUSDT</option>
                                        <option value="ADAUSDT">ADAUSDT</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="timeframe" class="form-label">æ—¶é—´çº§åˆ«</label>
                                    <select class="form-select" id="timeframe" name="timeframe">
                                        <option value="1m">1åˆ†é’Ÿ</option>
                                        <option value="5m">5åˆ†é’Ÿ</option>
                                        <option value="15m">15åˆ†é’Ÿ</option>
                                        <option value="1h" selected>1å°æ—¶</option>
                                        <option value="4h">4å°æ—¶</option>
                                        <option value="1d">1å¤©</option>
                                    </select>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-cog me-2"></i>äº¤æ˜“é™åˆ¶</h6>
                                <div class="mb-3">
                                    <label for="leverage" class="form-label">æ æ†å€æ•°</label>
                                    <select class="form-select" id="leverage" name="leverage">
                                        <option value="1">1x</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="5">5x</option>
                                        <option value="8" selected>8x</option>
                                        <option value="10">10x</option>
                                        <option value="20">20x</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„é‡‘ç®¡ç† -->
                    <div class="tab-pane fade" id="capital" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-dollar-sign me-2"></i>èµ„é‡‘é…ç½®</h6>
                                <div class="mb-3">
                                    <label for="initial_capital" class="form-label">åˆå§‹èµ„é‡‘ (USDT)</label>
                                    <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="10000" min="100" step="100">
                                    <div class="form-text">è®¾ç½®äº¤æ˜“ç³»ç»Ÿçš„åˆå§‹èµ„é‡‘</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä»“ä½ç®¡ç† -->
                    <div class="tab-pane fade" id="position" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-pie me-2"></i>ä»“ä½é…ç½®</h6>
                                <div class="mb-3">
                                    <label for="position_size_percent" class="form-label">å•æ¬¡ä»“ä½æ¯”ä¾‹ (%)</label>
                                    <input type="range" class="form-range" id="position_size_percent" name="position_size_percent" value="0.1" min="0.01" max="0.5" step="0.01">
                                    <div class="form-text">æ¯æ¬¡äº¤æ˜“ä½¿ç”¨çš„èµ„é‡‘æ¯”ä¾‹</div>
                                </div>
                                <div class="mb-3">
                                    <label for="max_position_size" class="form-label">æœ€å¤§ä»“ä½æ¯”ä¾‹ (%)</label>
                                    <input type="range" class="form-range" id="max_position_size" name="max_position_size" value="1.0" min="0.1" max="2.0" step="0.1">
                                    <div class="form-text">å…è®¸çš„æœ€å¤§ä»“ä½æ¯”ä¾‹</div>
                                </div>
                                <div class="mb-3">
                                    <label for="min_position_size" class="form-label">æœ€å°ä»“ä½æ¯”ä¾‹ (%)</label>
                                    <input type="range" class="form-range" id="min_position_size" name="min_position_size" value="0.2" min="0.01" max="1.0" step="0.01">
                                    <div class="form-text">å…è®¸çš„æœ€å°ä»“ä½æ¯”ä¾‹</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>å½“å‰è®¾ç½®</h6>
                                <div class="alert alert-info">
                                    <small>
                                        <strong>å•æ¬¡ä»“ä½æ¯”ä¾‹:</strong> <span id="current_position_size">10%</span><br>
                                        <strong>æœ€å¤§ä»“ä½æ¯”ä¾‹:</strong> <span id="current_max_position">100%</span><br>
                                        <strong>æœ€å°ä»“ä½æ¯”ä¾‹:</strong> <span id="current_min_position">20%</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¿è¡Œæ¨¡å¼ -->
                    <div class="tab-pane fade" id="mode" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-toggle-on me-2"></i>äº¤æ˜“æ¨¡å¼è®¾ç½®</h6>
                                <div class="mb-3">
                                    <label class="form-label">å½“å‰è¿è¡Œæ¨¡å¼</label>
                                    <div class="alert alert-warning">
                                        <span id="trading_mode_icon">ğŸŸ¡</span>
                                        <strong id="trading_mode_text">æ¨¡æ‹Ÿäº¤æ˜“</strong>
                                        <br>
                                        <small id="trading_mode_warning">ğŸŸ¡ æ¨¡æ‹Ÿäº¤æ˜“æ¨¡å¼ï¼Œä¸ä¼šä½¿ç”¨çœŸå®èµ„é‡‘</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">åˆ‡æ¢äº¤æ˜“æ¨¡å¼</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-danger" id="real_mode_btn" onclick="switchTradingMode('real')">
                                            <i class="fas fa-exclamation-triangle me-1"></i>åˆ‡æ¢åˆ°çœŸå®äº¤æ˜“æ¨¡å¼
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="simulation_mode_btn" onclick="switchTradingMode('simulation')">
                                            <i class="fas fa-shield-alt me-1"></i>åˆ‡æ¢åˆ°æ¨¡æ‹Ÿäº¤æ˜“æ¨¡å¼
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        çœŸå®äº¤æ˜“æ¨¡å¼å°†ä½¿ç”¨çœŸå®èµ„é‡‘ï¼Œè¯·è°¨æ…æ“ä½œï¼
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>æ¨¡å¼è¯´æ˜</h6>
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-shield-alt me-1"></i>æ¨¡æ‹Ÿäº¤æ˜“æ¨¡å¼</h6>
                                    <ul class="mb-2">
                                        <li>ä¸ä¼šä½¿ç”¨çœŸå®èµ„é‡‘</li>
                                        <li>é€‚åˆç­–ç•¥æµ‹è¯•å’ŒéªŒè¯</li>
                                        <li>æ— èµ„é‡‘é£é™©</li>
                                    </ul>
                                    <h6><i class="fas fa-exclamation-triangle me-1"></i>çœŸå®äº¤æ˜“æ¨¡å¼</h6>
                                    <ul class="mb-0">
                                        <li>ä½¿ç”¨çœŸå®èµ„é‡‘è¿›è¡Œäº¤æ˜“</li>
                                        <li>éœ€è¦é…ç½®APIå¯†é’¥</li>
                                        <li>å­˜åœ¨èµ„é‡‘é£é™©</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
            </div>
            
            <!-- é…ç½®æ“ä½œæŒ‰é’® -->
            <div class="card-footer py-4">
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-success btn-lg px-5" onclick="saveAllConfig()">
                        <i class="fas fa-save me-2"></i>ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<!-- é¡µé¢è„šæœ¬å·²ç§»åŠ¨åˆ°extra_jså—ä¸­ -->
{% endblock %} 