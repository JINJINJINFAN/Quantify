{% extends "base.html" %}

{% block title %}交易记录 - 交易系统{% endblock %}
{% block page_title %}交易记录{% endblock %}

{% block extra_css %}
<style>
.trade-card {
    transition: all 0.3s ease;
}
.trade-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.profit { color: #28a745; }
.loss { color: #dc3545; }
.neutral { color: #6c757d; }
.status-filled { color: #28a745; }
.status-canceled { color: #dc3545; }
.status-partial { color: #ffc107; }
.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}
.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 左侧：交易统计 -->
    <div class="col-md-3 mb-4">
        <div class="card stats-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>交易统计
                </h5>
            </div>
            <div class="card-body">
                <div id="tradeStats">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h4 mb-1" id="totalTrades">-</div>
                            <small>总交易数</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h4 mb-1" id="winRate">-</div>
                            <small>胜率</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h4 mb-1" id="totalProfit">-</div>
                            <small>总盈利</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h4 mb-1" id="profitFactor">-</div>
                            <small>盈亏比</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 快速筛选 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>筛选选项
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">交易类型</label>
                    <select class="form-select" id="tradeTypeFilter">
                        <option value="">全部</option>
                        <option value="LONG">多头</option>
                        <option value="SHORT">空头</option>
                        <option value="CLOSE">平仓</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">时间范围</label>
                    <select class="form-select" id="timeRangeFilter">
                        <option value="">全部</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search me-1"></i>应用筛选
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 右侧：交易记录表格 -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>交易历史
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshTrades()">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                   
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>时间</th>
                                <th>交易对</th>
                                <th>类型</th>
                                <th>数量</th>
                                <th>金额</th>
                                <th>价格</th>
                                <th>状态</th>
                                <th>盈亏</th>
                                
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <div class="mt-2">正在加载交易记录...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="交易记录分页" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页按钮将由JavaScript生成 -->
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentPage = 1;
let pageSize = 20;
let allTrades = [];
let filteredTrades = [];

// 页面加载后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTrades();
    loadTradeStats();
    
        // 订阅实时数据更新
    if (typeof socket !== 'undefined') {
        socket.on('status_update', function(data) {
            // 系统状态更新 - 可以用于更新页面状态指示器
            console.log('系统状态更新:', data);
            // 如果需要，可以在这里更新页面上的状态指示器
        });
        
        // 请求订阅实时更新
        socket.emit('subscribe_updates');
    }
});

// 加载交易记录
async function loadTrades() {
    try {
        const response = await fetch('/api/trades');
        const data = await response.json();
        
        if (data.success) {
            allTrades = data.trades || [];
            filteredTrades = [...allTrades];
            
            // // 添加调试信息
            // console.log('加载的交易数据:', allTrades);
            // if (allTrades.length > 0) {
            //     console.log('第一条交易记录:', allTrades[0]);
            //     console.log('数量字段:', allTrades[0].quantity, '类型:', typeof allTrades[0].quantity);
            //     console.log('金额字段:', allTrades[0].amount, '类型:', typeof allTrades[0].amount);
            // }
            
            updateTradesDisplay();
        } else {
            showError('加载交易记录失败: ' + data.message);
        }
    } catch (error) {
        console.error('加载交易记录错误:', error);
        showError('加载交易记录时发生错误');
    }
}

// 加载交易统计
async function loadTradeStats() {
    try {
        const response = await fetch('/api/trade_stats');
        const data = await response.json();
        
        if (data.success) {
            updateStatsDisplay(data.stats);
        } else {
            console.error('加载交易统计失败:', data.message);
        }
    } catch (error) {
        console.error('加载交易统计错误:', error);
    }
}

// 更新统计显示
function updateStatsDisplay(stats) {
    document.getElementById('totalTrades').textContent = stats.total_trades || 0;
    document.getElementById('winRate').textContent = (stats.win_rate || 0).toFixed(1) + '%';
    
    // 显示总盈亏（优先显示net_profit，如果没有则计算）
    const totalProfit = stats.net_profit !== undefined ? stats.net_profit : 
                       (stats.total_pnl !== undefined ? stats.total_pnl : 0);
    document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' USDT';
    
    // 显示盈亏比
    const profitFactor = stats.profit_factor || 0;
    document.getElementById('profitFactor').textContent = profitFactor === 999.99 ? '∞' : profitFactor.toFixed(2);
}

// 更新交易记录显示
function updateTradesDisplay() {
    const tbody = document.getElementById('tradesTableBody');
    
    if (filteredTrades.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <div>暂无交易记录</div>
                </td>
            </tr>
        `;
        return;
    }
    
    // 分页
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = filteredTrades.slice(start, end);
    
    tbody.innerHTML = pageData.map(trade => {
        try {
            const quantityDisplay = formatQuantity(trade.quantity, trade.type);
            const amountDisplay = formatAmount(trade.amount, trade.type);
            
            // console.log(`处理交易记录:`, {
            //     type: trade.type,
            //     quantity: trade.quantity,
            //     quantityDisplay: quantityDisplay,
            //     amount: trade.amount,
            //     amountDisplay: amountDisplay
            // });
            
            return `
                <tr>
                    <td>${formatDateTime(trade.timestamp)}</td>
                    <td>${trade.symbol || 'ETHUSDT'}</td>
                    <td>
                        <span class="badge ${getTradeTypeBadge(trade.type)}">
                            ${getTradeTypeText(trade.type)}
                        </span>
                    </td>
                    <td>${quantityDisplay}</td>
                    <td>${amountDisplay}</td>
                    <td>$${(trade.price || 0).toFixed(2)}</td>
                    <td>
                        <span class="badge ${getStatusBadge(trade.status || 'FILLED')}">
                            ${getStatusText(trade.status || 'FILLED')}
                        </span>
                    </td>
                    <td class="${getPnlClass(trade.pnl || 0)}">
                        ${formatPnl(trade.pnl)}
                    </td>
                </tr>
            `;
        } catch (error) {
            console.error('处理交易记录时出错:', error, trade);
            return `
                <tr>
                    <td colspan="8" class="text-danger">
                        数据处理错误: ${error.message}
                    </td>
                </tr>
            `;
        }
    }).join('');
    
    updatePagination();
}

// 应用筛选
function applyFilters() {
    const typeFilter = document.getElementById('tradeTypeFilter').value;
    const timeFilter = document.getElementById('timeRangeFilter').value;
    
    filteredTrades = allTrades.filter(trade => {
        // 交易类型筛选
        if (typeFilter) {
            const tradeType = trade.type;
            if (typeFilter === 'LONG' && !['LONG', 'BUY', '多头', '开多'].includes(tradeType?.toUpperCase())) return false;
            if (typeFilter === 'SHORT' && !['SHORT', 'SELL', '空头', '开空'].includes(tradeType?.toUpperCase())) return false;
            if (typeFilter === 'CLOSE' && !['CLOSE', 'RISK_CLOSE', 'SIGNAL_CLOSE', '平仓', '平多', '平空'].includes(tradeType?.toUpperCase())) return false;
        }
        // 时间范围筛选
        if (timeFilter && !isInTimeRange(trade.timestamp, timeFilter)) return false;
        return true;
    });
    
    currentPage = 1;
    updateTradesDisplay();
}

// 刷新交易记录
function refreshTrades() {
    loadTrades();
    loadTradeStats();

}
// 辅助函数
function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    const date = new Date(timestamp);
    return date.toLocaleString('zh-CN');
}

function formatQuantity(quantity, tradeType) {
    if (quantity === null || quantity === undefined) {
        return '-';
    }
    // 确保quantity是数字类型
    const numQuantity = parseFloat(quantity);
    if (isNaN(numQuantity)) {
        return '-';
    }
    
    // 正常显示正负数，包括0，使用更多小数位来显示很小的数值
    return `${numQuantity.toFixed(8)} ETH`;
}

function formatAmount(amount, tradeType) {
    if (amount === null || amount === undefined) {
        return '-';
    }
    // 确保amount是数字类型
    const numAmount = parseFloat(amount);
    if (isNaN(numAmount)) {
        return '-';
    }
    
    // 正常显示正负数，包括0
    // 对于平仓交易，如果金额为0，显示为"0.00 USDT (平仓)"
    if (numAmount === 0 && tradeType && (tradeType.toUpperCase().includes('CLOSE') || 
                                         tradeType.toUpperCase().includes('RISK_CLOSE') ||
                                         tradeType.toUpperCase().includes('SIGNAL_CLOSE') ||
                                         tradeType.toUpperCase().includes('平仓') ||
                                         tradeType.toUpperCase().includes('平多') ||
                                         tradeType.toUpperCase().includes('平空'))) {
        return '0.00 USDT (平仓)';
    }
    
    return `${numAmount.toFixed(2)} USDT`;
}

function formatPnl(pnl) {
    if (pnl === null || pnl === undefined) return '-';
    const value = parseFloat(pnl);
    if (isNaN(value)) return '-';
    // 正常显示正负数，包括0
    return value.toFixed(2) + ' USDT';
}

function getTradeTypeBadge(type) {
    switch(type?.toUpperCase()) {
        case 'LONG':
        case 'BUY':
        case '多头':
        case '开多':
            return 'bg-success';
        case 'SHORT':
        case 'SELL':
        case '空头':
        case '开空':
            return 'bg-danger';
        case 'CLOSE':
        case 'RISK_CLOSE':
        case 'SIGNAL_CLOSE':
        case '平仓':
        case '平多':
        case '平空':
            return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function getTradeTypeText(type) {
    switch(type?.toUpperCase()) {
        case 'LONG':
        case 'BUY':
        case '多头':
        case '开多':
            return '多头';
        case 'SHORT':
        case 'SELL':
        case '空头':
        case '开空':
            return '空头';
        case 'CLOSE':
        case 'RISK_CLOSE':
        case 'SIGNAL_CLOSE':
        case '平仓':
        case '平多':
        case '平空':
            return '平仓';
        default: return type || '-';
    }
}

function getStatusBadge(status) {
    switch(status) {
        case 'FILLED': return 'bg-success';
        case 'PARTIAL': return 'bg-warning';
        case 'CANCELED': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'FILLED': return '已成交';
        case 'PARTIAL': return '部分成交';
        case 'CANCELED': return '已取消';
        default: return status || '-';
    }
}

function getPnlClass(pnl) {
    if (pnl > 0) return 'profit';
    if (pnl < 0) return 'loss';
    return 'neutral';
}

function isInTimeRange(timestamp, range) {
    if (!timestamp) return false;
    
    const date = new Date(timestamp);
    const now = new Date();
    
    switch(range) {
        case 'today':
            return date.toDateString() === now.toDateString();
        case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return date >= weekAgo;
        case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            return date >= monthAgo;
        default:
            return true;
    }
}

function updatePagination() {
    const totalPages = Math.ceil(filteredTrades.length / pageSize);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // 上一页
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
        </li>
    `;
    
    // 页码
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    // 下一页
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredTrades.length / pageSize);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    updateTradesDisplay();
}

function showError(message) {
    const tbody = document.getElementById('tradesTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <div class="text-danger">${message}</div>
            </td>
        </tr>
    `;
}
</script>
{% endblock %}